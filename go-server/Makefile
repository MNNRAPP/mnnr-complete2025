# MNNR Docs Server - Go Makefile

.PHONY: help build run test clean docker-build docker-run deploy

# Default target
help:
	@echo "MNNR Docs Server - Available commands:"
	@echo ""
	@echo "  make build         - Build the Go binary"
	@echo "  make run           - Run the server locally"
	@echo "  make test          - Run tests"
	@echo "  make clean         - Clean build artifacts"
	@echo "  make docker-build  - Build Docker image"
	@echo "  make docker-run    - Run Docker container"
	@echo "  make deploy        - Deploy to production"
	@echo ""

# Build the application
build:
	@echo "ðŸ”¨ Building Go server..."
	go build -o server main.go
	@echo "âœ“ Build complete: ./server"

# Run the server locally
run:
	@echo "ðŸš€ Starting MNNR Docs Server..."
	go run main.go

# Run tests
test:
	@echo "ðŸ§ª Running tests..."
	go test -v ./...

# Clean build artifacts
clean:
	@echo "ðŸ§¹ Cleaning build artifacts..."
	rm -f server
	rm -f *.exe
	@echo "âœ“ Clean complete"

# Initialize Go modules
init:
	@echo "ðŸ“¦ Initializing Go modules..."
	go mod init github.com/mnnr/docs-server || true
	go mod tidy
	@echo "âœ“ Modules initialized"

# Download dependencies
deps:
	@echo "ðŸ“¥ Downloading dependencies..."
	go mod download
	go get github.com/gorilla/mux
	go get github.com/rs/cors
	go mod tidy
	@echo "âœ“ Dependencies downloaded"

# Build Docker image
docker-build:
	@echo "ðŸ³ Building Docker image..."
	docker build -t mnnr-docs-server:latest .
	@echo "âœ“ Docker image built: mnnr-docs-server:latest"

# Run Docker container
docker-run:
	@echo "ðŸ³ Running Docker container..."
	docker run -p 8080:8080 --name mnnr-docs mnnr-docs-server:latest

# Stop Docker container
docker-stop:
	@echo "ðŸ›‘ Stopping Docker container..."
	docker stop mnnr-docs || true
	docker rm mnnr-docs || true

# Deploy to production (Railway)
deploy:
	@echo "ðŸš€ Deploying to production..."
	railway up

# Development mode with auto-reload
dev:
	@echo "ðŸ”§ Starting development mode..."
	@command -v air > /dev/null || go install github.com/cosmtrek/air@latest
	air

# Format code
fmt:
	@echo "âœ¨ Formatting code..."
	go fmt ./...
	@echo "âœ“ Code formatted"

# Lint code
lint:
	@echo "ðŸ” Linting code..."
	@command -v golangci-lint > /dev/null || go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
	golangci-lint run
	@echo "âœ“ Linting complete"

# Run locally with production settings
prod-local:
	@echo "ðŸŽ¯ Running with production settings..."
	NODE_ENV=production PORT=8080 go run main.go

# Generate go.sum
tidy:
	@echo "ðŸ“‹ Tidying modules..."
	go mod tidy
	@echo "âœ“ Modules tidied"
