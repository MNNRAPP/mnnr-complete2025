# SEC-001: Security CI Workflow
# SBOM generation, SAST, dependency scanning, secret scanning

name: Security CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run security scans daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

# Limit permissions (SEC-003)
permissions:
  contents: read
  security-events: write
  pull-requests: write
  actions: read

jobs:
  # ============================================
  # DEPENDENCY SCANNING
  # ============================================
  dependency-scan:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: |
          npm audit --production --audit-level=moderate
        continue-on-error: false

      - name: Check for high/critical vulnerabilities
        run: |
          AUDIT_RESULT=$(npm audit --json | jq '.metadata.vulnerabilities | .high + .critical')
          if [ "$AUDIT_RESULT" -gt 0 ]; then
            echo "‚ùå Found $AUDIT_RESULT high/critical vulnerabilities"
            exit 1
          else
            echo "‚úÖ No high/critical vulnerabilities found"
          fi

  # ============================================
  # SBOM GENERATION
  # ============================================
  sbom-generation:
    name: Generate SBOM
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate SBOM (CycloneDX)
        run: |
          npx @cyclonedx/cyclonedx-npm \
            --output-format JSON \
            --output-file sbom.json \
            --short-PURLs

      - name: Upload SBOM artifact
        uses: actions/upload-artifact@v4
        with:
          name: sbom-${{ github.sha }}
          path: sbom.json
          retention-days: 90

      - name: SBOM Summary
        run: |
          echo "### üì¶ SBOM Generated" >> $GITHUB_STEP_SUMMARY
          echo "- Format: CycloneDX JSON" >> $GITHUB_STEP_SUMMARY
          echo "- Components: $(jq '.components | length' sbom.json)" >> $GITHUB_STEP_SUMMARY
          echo "- Timestamp: $(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # SAST (Static Application Security Testing)
  # ============================================
  sast-semgrep:
    name: SAST with Semgrep
    runs-on: ubuntu-latest
    container:
      image: returntocorp/semgrep
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Semgrep
        run: |
          semgrep \
            --config=auto \
            --error \
            --json \
            --output=semgrep-results.json \
            .
        continue-on-error: true

      - name: Upload Semgrep results
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-results-${{ github.sha }}
          path: semgrep-results.json
          retention-days: 90

      - name: Check for critical findings
        run: |
          if [ -f semgrep-results.json ]; then
            CRITICAL_COUNT=$(jq '[.results[] | select(.extra.severity == "ERROR")] | length' semgrep-results.json)
            echo "Found $CRITICAL_COUNT critical findings"

            if [ "$CRITICAL_COUNT" -gt 0 ]; then
              echo "‚ùå Critical security findings detected"
              jq '.results[] | select(.extra.severity == "ERROR") | {file: .path, line: .start.line, message: .extra.message}' semgrep-results.json
              exit 1
            fi
          fi

  # ============================================
  # ESLINT SECURITY RULES
  # ============================================
  eslint-security:
    name: ESLint Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint
        continue-on-error: false

  # ============================================
  # SECRET SCANNING
  # ============================================
  secret-scan:
    name: Secret Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better detection

      - name: Install gitleaks
        run: |
          wget -q https://github.com/gitleaks/gitleaks/releases/download/v8.18.0/gitleaks_8.18.0_linux_x64.tar.gz
          tar -xzf gitleaks_8.18.0_linux_x64.tar.gz
          chmod +x gitleaks

      - name: Run gitleaks
        run: |
          ./gitleaks detect \
            --source . \
            --report-format json \
            --report-path gitleaks-report.json \
            --verbose \
            --no-git
        continue-on-error: true

      - name: Check for leaked secrets
        run: |
          if [ -f gitleaks-report.json ] && [ "$(jq 'length' gitleaks-report.json)" -gt 0 ]; then
            echo "‚ùå Secrets detected in codebase!"
            jq '.[] | {file: .File, secret: .Secret, line: .StartLine}' gitleaks-report.json
            exit 1
          else
            echo "‚úÖ No secrets detected"
          fi

      - name: Upload gitleaks report
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-report-${{ github.sha }}
          path: gitleaks-report.json
          retention-days: 90

  # ============================================
  # DAST (Dynamic Application Security Testing)
  # ============================================
  dast-zap-baseline:
    name: OWASP ZAP Baseline Scan
    runs-on: ubuntu-latest
    # Only run on main branch or manually
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.10.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          target: 'https://mnnr.app'  # Replace with your staging URL
          rules_file_name: '.github/zap-rules.tsv'
          cmd_options: '-a -j -l WARN'
        continue-on-error: true

  # ============================================
  # BUNDLE ANALYSIS
  # ============================================
  bundle-security:
    name: Bundle Security Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build
        env:
          SKIP_ENV_VALIDATION: true
          NODE_ENV: production

      - name: Scan bundle for secrets
        run: |
          echo "üîç Scanning client bundle for exposed secrets..."

          # Check for common secret patterns
          FINDINGS=0

          # Stripe keys
          if grep -r "sk_live" .next/ 2>/dev/null; then
            echo "‚ùå Found Stripe secret key in bundle!"
            FINDINGS=$((FINDINGS + 1))
          fi

          # Supabase service role
          if grep -r "service_role" .next/ 2>/dev/null | grep -v "service_role_key"; then
            echo "‚ùå Found service role reference in bundle!"
            FINDINGS=$((FINDINGS + 1))
          fi

          # Database URLs
          if grep -r "postgresql://" .next/ 2>/dev/null; then
            echo "‚ùå Found database URL in bundle!"
            FINDINGS=$((FINDINGS + 1))
          fi

          # Generic secrets
          if grep -rE "(password|secret|apikey).*=.*['\"][a-zA-Z0-9]{20,}" .next/ 2>/dev/null; then
            echo "‚ö†Ô∏è  Found potential secret pattern in bundle"
            FINDINGS=$((FINDINGS + 1))
          fi

          if [ $FINDINGS -gt 0 ]; then
            echo "‚ùå Bundle security check failed: $FINDINGS issues found"
            exit 1
          else
            echo "‚úÖ No secrets found in client bundle"
          fi

  # ============================================
  # TYPESCRIPT TYPE SAFETY
  # ============================================
  type-check:
    name: TypeScript Type Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: TypeScript type check
        run: npx tsc --noEmit
        continue-on-error: true

  # ============================================
  # SECURITY SUMMARY
  # ============================================
  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [dependency-scan, sbom-generation, sast-semgrep, eslint-security, secret-scan, bundle-security]
    if: always()
    steps:
      - name: Generate Security Summary
        run: |
          echo "## üõ°Ô∏è Security CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Dependency Scan | ${{ needs.dependency-scan.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| SBOM Generation | ${{ needs.sbom-generation.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| SAST (Semgrep) | ${{ needs.sast-semgrep.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ESLint Security | ${{ needs.eslint-security.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Secret Scan | ${{ needs.secret-scan.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Bundle Security | ${{ needs.bundle-security.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow:** ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "**Run:** #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

      - name: Check overall status
        run: |
          if [ "${{ needs.dependency-scan.result }}" != "success" ] || \
             [ "${{ needs.secret-scan.result }}" != "success" ] || \
             [ "${{ needs.bundle-security.result }}" != "success" ]; then
            echo "‚ùå Security checks failed"
            exit 1
          else
            echo "‚úÖ All security checks passed"
          fi
